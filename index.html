<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title> مشروع أسامة الرحيلي</title>
<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
<style>
:root {
  --bg: #F5F7FA; --panel: #FFFFFF; --text: #2D3748; --muted: #718096;
  --primary: #5B8DEE; --secondary: #64B5F6; --border: #E2E8F0;
  --success: #48BB78; --error: #F56565; --grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
.header { text-align: center; padding: 25px; background: var(--grad); border-radius: 20px; color: white; margin-bottom: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
.header h1 { font-size: 32px; margin-bottom: 8px; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media (max-width: 900px) { 
  .grid { 
    grid-template-columns: 1fr;
    grid-template-rows: auto auto;
  }
  .grid > :first-child {
    order: 2;
  }
  .grid > :last-child {
    order: 1;
  }
}
.card { background: var(--panel); border-radius: 20px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border: 1px solid var(--border); }
.display { background: #F8FAFC; border: 2px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 20px; min-height: 100px; }
.expr { color: var(--muted); font-size: 16px; direction: ltr; text-align: left; min-height: 24px; word-break: break-all; }
.result { margin-top: 10px; font-weight: 700; font-size: 28px; direction: ltr; text-align: left; color: var(--primary); }
.keypad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
@media (max-width: 768px) {
  .keypad { gap: 8px; }
  .btn { padding: 14px 6px; font-size: 15px; }
  .btn.fn { font-size: 12px; }
}
.btn { padding: 16px 8px; border-radius: 12px; border: 1px solid var(--border); background: #F8FAFC; color: var(--text); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.btn:hover { background: var(--border); transform: translateY(-2px); }
.btn:active { transform: scale(0.95); }
.btn.op { background: var(--primary); color: white; }
.btn.fn { background: var(--secondary); color: white; font-size: 13px; }
.btn.clear { background: var(--error); color: white; }
.btn.equals { background: var(--grad); color: white; font-size: 20px; grid-column: span 2; }
.tools { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
.tool-btn { flex: 1; min-width: 120px; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: #F8FAFC; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.tool-btn:hover { background: var(--primary); color: white; }
#plot { width: 100%; height: 500px; border-radius: 16px; background: #FAFBFC; }
@media (max-width: 768px) { 
  #plot { 
    height: 450px;
    min-height: 450px;
    max-height: 450px;
  }
  .container {
    padding: 10px;
  }
  .header {
    padding: 15px;
    margin-bottom: 15px;
  }
  .header h1 {
    font-size: 24px;
  }
  .card {
    padding: 15px;
  }
}
.step-item { background: #F8FAFC; border-right: 3px solid var(--primary); padding: 12px 16px; margin: 8px 0; border-radius: 8px; font-size: 14px; line-height: 1.6; }
.history-item { background: #F8FAFC; padding: 10px 14px; margin: 8px 0; border-radius: 8px; cursor: pointer; border: 1px solid var(--border); direction: ltr; text-align: left; transition: all 0.2s; }
.history-item:hover { background: var(--primary); color: white; }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
.modal-content { background: var(--panel); margin: 5% auto; padding: 30px; border-radius: 20px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
.close { float: left; font-size: 32px; cursor: pointer; color: var(--muted); }
.close:hover { color: var(--error); }
.guide-section { margin: 20px 0; }
.guide-section h3 { color: var(--primary); margin-bottom: 10px; }
.example-code { background: #F8FAFC; padding: 8px 12px; border-radius: 8px; font-family: monospace; font-size: 13px; border-right: 3px solid var(--primary); margin: 5px 0; direction: ltr; text-align: left; cursor: pointer; }
.example-code:hover { background: var(--primary); color: white; }
.chatbot { position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--grad); color: white; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 999; }
.chatbot:hover { transform: scale(1.1); }
.chat-window { display: none; position: fixed; bottom: 90px; left: 20px; width: 350px; height: 500px; background: var(--panel); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 998; flex-direction: column; }
.chat-header { background: var(--grad); color: white; padding: 15px; font-weight: 600; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; }
.chat-messages { flex: 1; overflow-y: auto; padding: 15px; background: var(--bg); }
.chat-message { margin: 10px 0; padding: 10px 14px; border-radius: 12px; max-width: 80%; font-size: 14px; line-height: 1.5; }
.chat-message.user { background: var(--primary); color: white; margin-right: auto; direction: rtl; }
.chat-message.bot { background: #F8FAFC; color: var(--text); margin-left: auto; direction: rtl; white-space: pre-wrap; }
.chat-input-area { display: flex; padding: 15px; border-top: 1px solid var(--border); gap: 10px; }
.chat-input { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 12px; font-size: 14px; direction: rtl; }
.chat-send { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; }
.badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
.badge.success { background: #C6F6D5; color: #22543D; }
.badge.error { background: #FED7D7; color: #742A2A; }
#imageInput { display: none; }
@media (max-width: 768px) { .chat-window { width: calc(100% - 40px); left: 20px; } }
.quick-ops { display: flex; gap: 8px; margin-bottom: 10px; }
.quick-btn { padding: 8px 12px; border-radius: 8px; background: #E6F0FF; border: 1px solid var(--primary); color: var(--primary); font-size: 13px; cursor: pointer; font-weight: 600; }
.quick-btn:hover { background: var(--primary); color: white; }
</style>
</head>
<body>

<div id="instructionsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2 style="color: var(--primary); text-align: center; margin-bottom: 20px;">🎓 دليل الاستخدام</h2>
    <div class="guide-section">
      <h3>📝 اضغط على المثال لتجربته:</h3>
      <div class="example-code" onclick="tryExample('y=2*x+3')">y=2*x+3 (خطية)</div>
      <div class="example-code" onclick="tryExample('x^2-5*x+6=0')">x^2-5*x+6=0 (تربيعية)</div>
      <div class="example-code" onclick="tryExample('x^3-2*x^2+x=0')">x^3-2*x^2+x=0 (تكعيبية)</div>
      <div class="example-code" onclick="tryExample('y=sqrt(x+2)')">y=sqrt(x+2) (جذرية)</div>
      <div class="example-code" onclick="tryExample('y=abs(x-3)')">y=abs(x-3) (قيمة مطلقة)</div>
      <div class="example-code" onclick="tryExample('y=1/(x-2)')">y=1/(x-2) (مقلوب - منفصلة)</div>
      <div class="example-code" onclick="tryExample('y=(x^2-4)/(x-2)')">y=(x^2-4)/(x-2) (انفصال قابل للإزالة)</div>
    </div>
    <button onclick="closeModal()" style="width: 100%; padding: 14px; background: var(--grad); color: white; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; margin-top: 20px;">فهمت! 🚀</button>
  </div>
</div>

<div class="container">
  <div class="header">
    <h1>🧮 مشروع أسامة الرحيلي</h1>
    <p>حل وتمثيل جميع أنواع الدوال الرياضية</p>
  </div>

  <div class="grid">
    <div class="card">
      <h3 style="margin-bottom: 15px; color: var(--primary);">📊 الرسم البياني</h3>
      <div id="plot"></div>
    </div>

    <div>
      <div class="card">
        <div class="display">
          <div class="expr" id="expr">اكتب معادلة...</div>
          <div class="result" id="result">= —</div>
        </div>

        <div class="quick-ops">
          <button class="quick-btn" onclick="add('(')">( فتح</button>
          <button class="quick-btn" onclick="add(')')">) إغلاق</button>
          <button class="quick-btn" onclick="add('+')">+ جمع</button>
          <button class="quick-btn" onclick="add('-')">- طرح</button>
          <button class="quick-btn" onclick="add('*')">× ضرب</button>
          <button class="quick-btn" onclick="add('/')">÷ قسمة</button>
          <button class="quick-btn" onclick="add('=0')">=0</button>
          <button class="quick-btn" onclick="autoClose()">)( إغلاق تلقائي</button>
        </div>

        <div class="tools">
          <label for="imageInput" class="tool-btn">📸 صورة</label>
          <input type="file" id="imageInput" accept="image/*">
          <button class="tool-btn" onclick="showModal()">📖 دليل</button>
          <button class="tool-btn" onclick="clearHistory()">🗑️ مسح</button>
          <button class="tool-btn" onclick="addSecond()">➕ دالة 2</button>
        </div>

        <div class="keypad">
          <button class="btn fn" onclick="add('sqrt(')">√</button>
          <button class="btn fn" onclick="add('abs(')">| |</button>
          <button class="btn fn" onclick="add('sin(')">sin</button>
          <button class="btn fn" onclick="add('cos(')">cos</button>
          <button class="btn fn" onclick="add('ln(')">ln</button>
          <button class="btn" onclick="add('(')">(</button>
          <button class="btn" onclick="add(')')">)</button>
          <button class="btn op" onclick="add('^')">x^y</button>
          <button class="btn op" onclick="add('/')">÷</button>
          <button class="btn clear" onclick="back()">⌫</button>
          <button class="btn" onclick="add('7')">7</button>
          <button class="btn" onclick="add('8')">8</button>
          <button class="btn" onclick="add('9')">9</button>
          <button class="btn op" onclick="add('*')">×</button>
          <button class="btn fn" onclick="add('1/')">1/x</button>
          <button class="btn" onclick="add('4')">4</button>
          <button class="btn" onclick="add('5')">5</button>
          <button class="btn" onclick="add('6')">6</button>
          <button class="btn op" onclick="add('-')">−</button>
          <button class="btn op" onclick="add('y=')">y=</button>
          <button class="btn" onclick="add('1')">1</button>
          <button class="btn" onclick="add('2')">2</button>
          <button class="btn" onclick="add('3')">3</button>
          <button class="btn op" onclick="add('+')">+</button>
          <button class="btn op" onclick="add('x')">x</button>
          <button class="btn clear" onclick="clearAll()">AC</button>
          <button class="btn" onclick="add('0')">0</button>
          <button class="btn" onclick="add('.')">.</button>
          <button class="btn equals" onclick="solve()">حل =</button>
        </div>
        <div id="status" class="badge" style="display: none;"></div>
      </div>

      <div class="card" style="margin-top: 20px;">
        <h3 style="margin-bottom: 10px; color: var(--primary);">🔢 خطوات الحل</h3>
        <div id="steps"><div class="step-item">— لا توجد خطوات —</div></div>
      </div>

      <div class="card" style="margin-top: 20px;">
        <h3 style="margin-bottom: 10px; color: var(--primary);">📜 السجل</h3>
        <div id="history" style="max-height: 200px; overflow-y: auto;"><p style="text-align: center; color: var(--muted); font-size: 14px;">لا توجد حسابات</p></div>
      </div>
    </div>
  </div>
</div>

<div class="chatbot" onclick="toggleChat()">💬</div>
<div class="chat-window" id="chatWindow">
  <div class="chat-header"><span>🤖 المساعد الذكي</span><span onclick="toggleChat()" style="cursor: pointer;">✕</span></div>
  <div class="chat-messages" id="chatMessages"><div class="chat-message bot">مرحباً! أنا هنا لمساعدتك في شرح المعادلات وطرق الحل.</div></div>
  <div class="chat-input-area">
    <input type="text" class="chat-input" id="chatInput" placeholder="اسأل عن أي شيء..." onkeypress="if(event.key==='Enter') sendChat()">
    <button class="chat-send" onclick="sendChat()">إرسال</button>
  </div>
</div>

<script>
// 🔑 ضع API Key هنا (بين علامات التنصيص)
const API_KEY = 'YOUR_OPENAI_API_KEY_HERE';

let expr = '';
let history = JSON.parse(localStorage.getItem('history') || '[]');
let secondFunc = null;

window.onload = function() {
  if (!localStorage.getItem('visited')) { showModal(); localStorage.setItem('visited', '1'); }
  loadHistory(); plotWelcome();
};

function showModal() { document.getElementById('instructionsModal').style.display = 'block'; }
function closeModal() { document.getElementById('instructionsModal').style.display = 'none'; }
function tryExample(ex) { expr = ex; update(); closeModal(); solve(); }
function add(t) { expr += t; update(); }
function back() { expr = expr.slice(0, -1); update(); }
function clearAll() { expr = ''; secondFunc = null; update(); document.getElementById('steps').innerHTML = '<div class="step-item">— لا توجد خطوات —</div>'; document.getElementById('status').style.display = 'none'; plotWelcome(); }
function update() { document.getElementById('expr').textContent = expr || 'اكتب معادلة...'; }
function showStatus(type, msg) { const s = document.getElementById('status'); s.className = `badge ${type}`; s.textContent = msg; s.style.display = 'inline-block'; }

function addSecond() {
  if (!expr) { alert('⚠️ أدخل الدالة الأولى'); return; }
  secondFunc = expr; expr = ''; update(); showStatus('success', '✓ أدخل الثانية');
}

function autoClose() {
  // حساب عدد الأقواس المفتوحة والمغلقة
  const openCount = (expr.match(/\(/g) || []).length;
  const closeCount = (expr.match(/\)/g) || []).length;
  const needed = openCount - closeCount;
  
  if (needed > 0) {
    // أضف الأقواس المطلوبة
    expr += ')'.repeat(needed);
    update();
    showStatus('success', `✓ تم إضافة ${needed} قوس`);
  } else if (needed === 0) {
    showStatus('success', '✓ الأقواس متوازنة');
  } else {
    showStatus('error', '⚠️ أقواس إغلاق زائدة');
  }
}

function solve() {
  if (!expr.trim()) { showStatus('error', '⚠️ أدخل معادلة'); return; }
  try {
    // تحويل =0 إلى y=...
    let equation = expr;
    if (equation.includes('=0') && !equation.startsWith('y=')) {
      equation = 'y=' + equation.replace('=0', '');
    }
    
    const steps = analyzeEquation(equation);
    displaySteps(steps);
    
    if (secondFunc) { 
      plotMultiple([secondFunc, equation]); 
      showStatus('success', '✓ رسم دالتين'); 
      secondFunc = null; 
    } else { 
      plotSingle(equation); 
      showStatus('success', '✓ تم الحل'); 
    }
    addToHistory(expr);
  } catch (e) { 
    showStatus('error', '❌ خطأ: ' + e.message); 
    console.error(e);
  }
}

function analyzeEquation(eq) {
  const steps = [];
  const cleanEq = eq.toLowerCase().replace(/\s+/g, '');
  
  // تحديد نوع الدالة
  if (cleanEq.includes('sqrt')) {
    steps.push('📐 دالة جذرية: y = √f(x)');
    steps.push('التحليل:');
    steps.push('• المجال: القيم تحت الجذر ≥ 0');
    steps.push('• المدى: y ≥ 0 (الجذر التربيعي دائماً موجب)');
    steps.push('• الدالة تبدأ من نقطة معينة وتتزايد تدريجياً');
    steps.push('• معدل التزايد يقل كلما زاد x');
  } 
  else if (cleanEq.includes('abs')) {
    steps.push('📊 دالة القيمة المطلقة: y = |f(x)|');
    steps.push('الخصائص:');
    steps.push('• القيمة دائماً موجبة أو صفر');
    steps.push('• تشكل زاوية على شكل حرف V');
    steps.push('• نقطة الانعطاف عند القيمة التي تصفر المقدار الداخلي');
    steps.push('• الدالة متماثلة حول نقطة الانعطاف');
  }
  else if (cleanEq.match(/\/(x[+-]\d+)/)) {
    const discontinuity = cleanEq.match(/x([+-]\d+)/);
    steps.push('↔️ دالة المقلوب (دالة منفصلة)');
    steps.push('نوع الانفصال: انفصال لا نهائي');
    steps.push('التحليل:');
    if (discontinuity) {
      const point = discontinuity[1].replace('+', '');
      steps.push(`• خط تقارب رأسي عند x = ${point} (القاسم = 0)`);
    } else {
      steps.push('• خط تقارب رأسي عند x = 0');
    }
    steps.push('• خط تقارب أفقي عند y = 0');
    steps.push('• المجال: جميع الأعداد الحقيقية عدا نقطة الانفصال');
    steps.push('• الدالة تقترب من ±∞ عند الاقتراب من خط التقارب');
  }
  else if (cleanEq.match(/\(x\^2[^)]+\)\/\(x[+-]\d+\)/)) {
    steps.push('📍 دالة كسرية (انفصال قابل للإزالة)');
    steps.push('نوع الانفصال: انفصال قابل للإزالة (ثقب)');
    steps.push('التحليل:');
    steps.push('• يمكن تبسيط الدالة بحذف العامل المشترك');
    steps.push('• توجد نقطة ثقب (غير معرفة) عند القيمة التي تصفر المقام');
    steps.push('• باقي الدالة متصلة');
  }
  else if (cleanEq.match(/x\^3/) || cleanEq.match(/x\*\*3/)) {
    steps.push('📈 دالة تكعيبية: y = ax³ + bx² + cx + d');
    steps.push('الخصائص:');
    steps.push('• الشكل: منحنى على شكل S');
    steps.push('• الدرجة: 3 (تكعيبية)');
    steps.push('• عدد الجذور: حتى 3 جذور حقيقية');
    steps.push('• نقاط انعطاف: نقطة واحدة');
    steps.push('• السلوك عند اللانهاية: تذهب لـ +∞ أو -∞ حسب إشارة a');
  }
  else if ((cleanEq.match(/x\^2/) || cleanEq.match(/x\*\*2/)) && cleanEq.includes('=0')) {
    steps.push('📐 معادلة تربيعية: ax² + bx + c = 0');
    steps.push('طريقة الحل:');
    steps.push('• الصيغة القياسية: ax² + bx + c = 0');
    steps.push('• القانون العام: x = (-b ± √Δ) / 2a');
    steps.push('• المميز: Δ = b² - 4ac');
    steps.push('  - إذا Δ > 0: جذران حقيقيان مختلفان');
    steps.push('  - إذا Δ = 0: جذر حقيقي واحد (مكرر)');
    steps.push('  - إذا Δ < 0: جذران تخيليان');
  }
  else if (cleanEq.match(/x\^2/) || cleanEq.match(/x\*\*2/)) {
    steps.push('📐 دالة تربيعية: y = ax² + bx + c');
    steps.push('الخصائص:');
    steps.push('• الشكل: قطع مكافئ (منحنى U)');
    steps.push('• الرأس: نقطة القيمة العظمى أو الصغرى');
    steps.push('• محور التماثل: خط رأسي يمر بالرأس');
    steps.push('• الاتجاه: لأعلى إذا a > 0، لأسفل إذا a < 0');
  }
  else if (cleanEq.includes('sin') || cleanEq.includes('cos')) {
    steps.push('〰️ دالة مثلثية');
    steps.push('الخصائص:');
    steps.push('• دالة دورية: تتكرر كل 2π');
    steps.push('• المدى: [-1, 1]');
    steps.push('• تستخدم في النماذج الموجية');
  }
  else if (cleanEq.includes('tan')) {
    steps.push('〰️ دالة الظل tan(x)');
    steps.push('خصائص:');
    steps.push('• دالة منفصلة: انفصال لا نهائي');
    steps.push('• خطوط تقارب رأسية عند x = ±π/2, ±3π/2, ...');
    steps.push('• الدورية: π');
  }
  else if (cleanEq.includes('ln') || cleanEq.includes('log')) {
    steps.push('📈 دالة لوغاريتمية');
    steps.push('الخصائص:');
    steps.push('• المجال: x > 0 فقط');
    steps.push('• خط تقارب رأسي: x = 0');
    steps.push('• تتزايد ببطء مع زيادة x');
  }
  else if (cleanEq.match(/y\s*=.*x/)) {
    steps.push('📏 دالة خطية: y = mx + b');
    steps.push('العناصر:');
    steps.push('• m: الميل (معدل التغير)');
    steps.push('• b: تقاطع المحور y');
    steps.push('• الشكل: خط مستقيم');
  }
  else {
    steps.push('📊 دالة رياضية');
    steps.push('سيتم رسمها وتحليلها');
  }
  
  return steps;
}

function displaySteps(steps) { 
  document.getElementById('steps').innerHTML = steps.map(s => `<div class="step-item">${s}</div>`).join(''); 
}

function plotWelcome() {
  const layout = { 
    autosize: true, 
    plot_bgcolor: '#FAFBFC', 
    paper_bgcolor: '#FAFBFC',
    xaxis: { 
      range: [-10, 10], 
      dtick: 1,
      fixedrange: true,
      showgrid: true, 
      gridcolor: '#E2E8F0', 
      zeroline: true, 
      zerolinecolor: '#1A202C', 
      zerolinewidth: 3, 
      scaleanchor: 'y', 
      scaleratio: 1,
      constrain: 'domain',
      title: { text: 'X', font: { size: 14 } }
    },
    yaxis: { 
      range: [-10, 10], 
      dtick: 1,
      fixedrange: true,
      showgrid: true, 
      gridcolor: '#E2E8F0', 
      zeroline: true, 
      zerolinecolor: '#1A202C', 
      zerolinewidth: 3,
      constrain: 'domain',
      title: { text: 'Y', font: { size: 14 } }
    },
    margin: { l: 60, r: 40, t: 40, b: 60 }
  };
  Plotly.newPlot('plot', [], layout, { 
    responsive: true, 
    displayModeBar: false,
    staticPlot: true
  });
}

function plotSingle(eq) {
  const x = [], y = [];
  
  // نقاط كثيرة للدقة
  for (let i = -10; i <= 10; i += 0.02) {
    x.push(i);
    try {
      const val = evalExpr(eq, i);
      // فلترة القيم
      if (isFinite(val) && !isNaN(val) && Math.abs(val) < 1000) {
        y.push(val);
      } else {
        y.push(null);
      }
    } catch {
      y.push(null);
    }
  }

  const trace = { 
    x, 
    y,
    type: 'scatter',
    mode: 'lines',
    name: eq,
    line: { 
      width: 3, 
      color: '#5B8DEE'
    },
    connectgaps: false
  };

  const yVals = y.filter(v => v !== null && isFinite(v));
  let yMin = Math.min(...yVals);
  let yMax = Math.max(...yVals);
  
  // ضبط المدى
  if (yMax - yMin < 2) {
    yMin -= 5;
    yMax += 5;
  } else {
    const margin = (yMax - yMin) * 0.1;
    yMin -= margin;
    yMax += margin;
  }
  
  yMin = Math.max(yMin, -50);
  yMax = Math.min(yMax, 50);

  const layout = { 
    autosize: true, 
    plot_bgcolor: '#FAFBFC', 
    paper_bgcolor: '#FAFBFC',
    xaxis: { 
      range: [-10, 10], 
      dtick: 1,
      fixedrange: true,
      showgrid: true, 
      gridcolor: '#E2E8F0', 
      zeroline: true, 
      zerolinecolor: '#1A202C', 
      zerolinewidth: 3, 
      scaleanchor: 'y', 
      scaleratio: 1,
      constrain: 'domain',
      title: { text: 'X', font: { size: 14 } }
    },
    yaxis: { 
      range: [yMin, yMax], 
      dtick: 1,
      fixedrange: true,
      showgrid: true, 
      gridcolor: '#E2E8F0', 
      zeroline: true, 
      zerolinecolor: '#1A202C', 
      zerolinewidth: 3,
      constrain: 'domain',
      title: { text: 'Y', font: { size: 14 } }
    },
    margin: { l: 60, r: 40, t: 40, b: 60 },
    showlegend: true,
    legend: {
      x: 0.02,
      y: 0.98,
      bgcolor: 'rgba(255,255,255,0.8)',
      bordercolor: '#E2E8F0',
      borderwidth: 1
    }
  };

  Plotly.newPlot('plot', [trace], layout, { 
    responsive: true, 
    displayModeBar: false,
    staticPlot: true,
    scrollZoom: false,
    doubleClick: false
  });
}

function plotMultiple(funcs) {
  const colors = ['#5B8DEE', '#E85D75'];
  
  const traces = funcs.map((eq, i) => {
    const x = [], y = [];
    for (let j = -10; j <= 10; j += 0.02) {
      x.push(j);
      try {
        const v = evalExpr(eq, j);
        if (isFinite(v) && !isNaN(v) && Math.abs(v) < 1000) {
          y.push(v);
        } else {
          y.push(null);
        }
      } catch {
        y.push(null);
      }
    }
    return { 
      x, 
      y, 
      type: 'scatter', 
      mode: 'lines', 
      name: eq, 
      line: { width: 3, color: colors[i] }, 
      connectgaps: false 
    };
  });

  const layout = { 
    autosize: true, 
    plot_bgcolor: '#FAFBFC', 
    paper_bgcolor: '#FAFBFC',
    xaxis: { 
      range: [-10, 10], 
      dtick: 1,
      fixedrange: true,
      showgrid: true, 
      gridcolor: '#E2E8F0', 
      zeroline: true, 
      zerolinecolor: '#1A202C', 
      zerolinewidth: 3, 
      scaleanchor: 'y', 
      scaleratio: 1,
      constrain: 'domain',
      title: { text: 'X', font: { size: 14 } }
    },
    yaxis: { 
      range: [-10, 10], 
      dtick: 1,
      fixedrange: true,
      showgrid: true, 
      gridcolor: '#E2E8F0', 
      zeroline: true, 
      zerolinecolor: '#1A202C', 
      zerolinewidth: 3,
      constrain: 'domain',
      title: { text: 'Y', font: { size: 14 } }
    },
    margin: { l: 60, r: 40, t: 40, b: 60 },
    showlegend: true
  };

  Plotly.newPlot('plot', traces, layout, { 
    responsive: true, 
    displayModeBar: false,
    staticPlot: true,
    scrollZoom: false,
    doubleClick: false
  });
}

function evalExpr(eq, xVal) {
  let e = eq.replace(/y\s*=/g, '').trim();
  
  // تحويل الدوال
  e = e.replace(/\^/g, '**');
  e = e.replace(/sqrt\(/g, 'Math.sqrt(');
  e = e.replace(/abs\(/g, 'Math.abs(');
  e = e.replace(/sin\(/g, 'Math.sin(');
  e = e.replace(/cos\(/g, 'Math.cos(');
  e = e.replace(/tan\(/g, 'Math.tan(');
  e = e.replace(/ln\(/g, 'Math.log(');
  e = e.replace(/log\(/g, 'Math.log10(');
  
  // استبدال x بالقيمة
  e = e.replace(/(\d)x/g, '$1*x'); // 2x -> 2*x
  e = e.replace(/x/g, `(${xVal})`);
  
  return eval(e);
}

function addToHistory(eq) { 
  history.unshift(eq); 
  if (history.length > 10) history.pop(); 
  localStorage.setItem('history', JSON.stringify(history)); 
  loadHistory(); 
}

function loadHistory() {
  const h = document.getElementById('history');
  if (history.length === 0) {
    h.innerHTML = '<p style="text-align: center; color: var(--muted); font-size: 14px;">لا توجد حسابات</p>';
  } else {
    h.innerHTML = history.map(eq => 
      `<div class="history-item" onclick="expr='${eq}'; update(); solve();">${eq}</div>`
    ).join('');
  }
}

function clearHistory() { 
  if (confirm('مسح السجل؟')) { 
    history = []; 
    localStorage.removeItem('history'); 
    loadHistory(); 
  } 
}

function toggleChat() { 
  const chat = document.getElementById('chatWindow'); 
  chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex'; 
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  
  addChatMessage('user', msg);
  input.value = '';
  
  if (!API_KEY || API_KEY === 'YOUR_OPENAI_API_KEY_HERE') {
    addChatMessage('bot', '⚠️ الرجاء إضافة API Key في الكود أولاً.');
    return;
  }
  
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_KEY}`
      },
      body: JSON.stringify({
        model: 'gpt-3.5-turbo',
        messages: [
          { 
            role: 'system', 
            content: 'أنت مساعد رياضيات محترف. تشرح المعادلات وطرق الحل بطريقة واضحة وبسيطة بالعربية. استخدم الأمثلة والخطوات المفصلة.' 
          },
          { role: 'user', content: msg }
        ],
        max_tokens: 500,
        temperature: 0.7
      })
    });
    
    if (!response.ok) {
      throw new Error('فشل الاتصال بـ API');
    }
    
    const data = await response.json();
    const reply = data.choices[0].message.content;
    addChatMessage('bot', reply);
  } catch (e) {
    console.error(e);
    addChatMessage('bot', '❌ عذراً، حدث خطأ. تأكد من:\n• صحة API Key\n• الاتصال بالإنترنت\n• وجود رصيد في حساب OpenAI');
  }
}

function addChatMessage(type, text) {
  const div = document.createElement('div');
  div.className = `chat-message ${type}`;
  div.textContent = text;
  document.getElementById('chatMessages').appendChild(div);
  const chatMessages = document.getElementById('chatMessages');
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

update();
plotWelcome();
</script>
</body>
</html>